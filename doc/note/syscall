<mxfile host="app.diagrams.net" modified="2023-12-07T15:45:45.968Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0" etag="Bt0GEG4r8lB6Q74DhosV" version="22.1.7" type="device">
  <diagram name="第 1 页" id="wHAHtwoglfUj18YWvQLC">
    <mxGraphModel dx="2385" dy="2537" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="rG94a1LRT6dkGuhy65Fh-84" value="" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="66" y="-290" width="2074" height="1530" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-1" value="" style="endArrow=none;dashed=1;html=1;rounded=0;strokeWidth=4;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="110" y="250" as="sourcePoint" />
            <mxPoint x="1996.6666666666667" y="250" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-8" value="" style="group" vertex="1" connectable="0" parent="1">
          <mxGeometry x="96" y="40" width="90" height="130" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-2" value="...&lt;br&gt;system call&lt;br&gt;..." style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;align=left;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-8">
          <mxGeometry x="5" width="80" height="100" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-4" value="user application" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-8">
          <mxGeometry y="100" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-6" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;fillColor=default;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="171" y="89.5" as="sourcePoint" />
            <mxPoint x="271" y="90" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-20" value="" style="group" vertex="1" connectable="0" parent="1">
          <mxGeometry x="281" y="10" width="80" height="160" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-9" value="user.h" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-20">
          <mxGeometry x="10" y="130" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-10" value="&lt;div style=&quot;border-color: var(--border-color); text-align: left;&quot;&gt;int fork(void);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color); text-align: left;&quot;&gt;int wait(int*);&lt;br style=&quot;border-color: var(--border-color);&quot;&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color); text-align: left;&quot;&gt;int pipe(int*);&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color); text-align: left;&quot;&gt;...&lt;/div&gt;" style="shape=card;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-20">
          <mxGeometry y="30" width="80" height="100" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-11" value="System call&lt;br&gt;Prototype" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-20">
          <mxGeometry width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-17" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;fillColor=default;entryX=-0.014;entryY=0.18;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" target="rG94a1LRT6dkGuhy65Fh-15">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="357" y="68" as="sourcePoint" />
            <mxPoint x="457" y="68.5" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-21" value="" style="group" vertex="1" connectable="0" parent="1">
          <mxGeometry x="461" y="20" width="110" height="160" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-16" value="" style="group" vertex="1" connectable="0" parent="rG94a1LRT6dkGuhy65Fh-21">
          <mxGeometry y="30" width="110" height="130" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-14" value="usys.S" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-16">
          <mxGeometry x="25" y="100" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-15" value="&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;.global fork&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;fork:&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp;li a7, &lt;font color=&quot;#ff8000&quot;&gt;SYS_fork&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp;&lt;font color=&quot;#0000ff&quot;&gt;ecall&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;&amp;nbsp;&lt;font color=&quot;#00cc00&quot;&gt;ret&lt;/font&gt;&lt;/div&gt;.global wait&lt;div style=&quot;border-color: var(--border-color);&quot;&gt;...&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;align=left;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-16">
          <mxGeometry width="110" height="100" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-18" value="Stub" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-21">
          <mxGeometry x="30" width="50" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-22" value="Load syscall number in &lt;b&gt;a7&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#ff8000&quot;&gt;SYS_xxx&lt;/font&gt; defined in &lt;u&gt;Syscall.h&lt;/u&gt;" style="shape=callout;whiteSpace=wrap;html=1;perimeter=calloutPerimeter;size=20;position=0.17;position2=0;align=center;" vertex="1" parent="1">
          <mxGeometry x="551" y="20" width="180" height="60" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-29" value="generated by usys.pl" style="ellipse;shape=cloud;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="530" y="110" width="110" height="60" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-35" value="stvec" style="shape=hexagon;perimeter=hexagonPerimeter2;whiteSpace=wrap;html=1;fixedSize=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="580" y="565" width="59" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-38" value="" style="group" vertex="1" connectable="0" parent="1">
          <mxGeometry x="649" y="560" width="84" height="140" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-30" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-38">
          <mxGeometry width="84" height="110" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-31" value="uservec" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-38">
          <mxGeometry x="7.5" y="35" width="69" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-32" value="userret" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-38">
          <mxGeometry x="7.5" y="70" width="69" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-33" value="trampoline.S" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-38">
          <mxGeometry x="3" y="110" width="78" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-39" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="rG94a1LRT6dkGuhy65Fh-35" target="rG94a1LRT6dkGuhy65Fh-31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-40" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;curved=1;strokeColor=#0000FF;" edge="1" parent="1" source="rG94a1LRT6dkGuhy65Fh-15" target="rG94a1LRT6dkGuhy65Fh-31">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="380" y="100" />
              <mxPoint x="380" y="610" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-41" value="&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;1. Swap sscratch and a0 so that a0 is TRAPFRAME&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;(sscratch holds the user a0 for now.)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 14px;&quot;&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;2. Save the user registers in TRAPFRAME&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;3. Save the user a0 (sscratch) in&amp;nbsp;TRAPFRAME&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;4. Restore kernel stack pointer from p-&amp;gt;trapframe-&amp;gt;kernel_sp&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;5. Make tp hold the current hartid, from p-&amp;gt;trapframe-&amp;gt;kernel_hartid&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;6. Load the address of usertrap(), p-&amp;gt;trapframe-&amp;gt;kernel_trap, to t0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;7. Restore kernel page table from p-&amp;gt;trapframe-&amp;gt;kernel_satp&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;================= Fence (for page table) ==================&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;8. Jump to &lt;font color=&quot;#0000ff&quot;&gt;usertrap&lt;/font&gt;(), which does not return.&lt;/font&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=right;" vertex="1" parent="1">
          <mxGeometry x="832" y="410" width="460" height="200" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-42" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;endArrow=none;endFill=0;" edge="1" parent="1" source="rG94a1LRT6dkGuhy65Fh-31" target="rG94a1LRT6dkGuhy65Fh-41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-43" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;endArrow=none;endFill=0;" edge="1" parent="1" source="rG94a1LRT6dkGuhy65Fh-31" target="rG94a1LRT6dkGuhy65Fh-41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-57" value="" style="group" vertex="1" connectable="0" parent="1">
          <mxGeometry x="1220" y="-260" width="220" height="475" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-52" value="" style="group" vertex="1" connectable="0" parent="rG94a1LRT6dkGuhy65Fh-57">
          <mxGeometry x="100" y="15" width="120" height="415" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-45" value="TRAMPOLINE" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-52">
          <mxGeometry width="120" height="35" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-46" value="TRAPFRAME" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-52">
          <mxGeometry y="35" width="120" height="35" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-47" value="heap" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-52">
          <mxGeometry y="70" width="120" height="115" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-48" value="stack" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-52">
          <mxGeometry y="185" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-49" value="guard page" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-52">
          <mxGeometry y="225" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-50" value="data" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-52">
          <mxGeometry y="265" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-51" value="text" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-52">
          <mxGeometry y="305" width="120" height="110" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-54" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="rG94a1LRT6dkGuhy65Fh-57" source="rG94a1LRT6dkGuhy65Fh-53" target="rG94a1LRT6dkGuhy65Fh-51">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-53" value="&lt;font style=&quot;font-size: 16px;&quot;&gt;0&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-57">
          <mxGeometry x="40" y="415" width="20" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-56" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="rG94a1LRT6dkGuhy65Fh-57" source="rG94a1LRT6dkGuhy65Fh-55" target="rG94a1LRT6dkGuhy65Fh-45">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-55" value="&lt;font style=&quot;font-size: 16px;&quot;&gt;MAXVA&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-57">
          <mxGeometry width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-58" value="&lt;b&gt;User Address Space&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-57">
          <mxGeometry x="40" y="445" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-60" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0;entryY=0.074;entryDx=0;entryDy=0;entryPerimeter=0;fillColor=default;" edge="1" parent="1" target="rG94a1LRT6dkGuhy65Fh-61">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1260" y="470" as="sourcePoint" />
            <mxPoint x="1470" y="510" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-64" value="" style="group" vertex="1" connectable="0" parent="1">
          <mxGeometry x="1520" y="450" width="338" height="300" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-61" value="&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;Make stvec point to &lt;/span&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;kernelvec&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;struct proc *p = myproc();&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;Save user program counter.&amp;nbsp;p-&amp;gt;trapframe-&amp;gt;epc = r_sepc();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;if(r_scause() == 8) { // System call&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;&quot;&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;// sepc points to the ecall instruction,&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;// but we want to return to the next instruction.&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;p-&amp;gt;trapframe-&amp;gt;epc += 4;&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;span style=&quot;&quot;&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;intr_on(); // enable interrupt&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;span style=&quot;&quot;&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;syscall();&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;} else { ... }&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;// give up the CPU if this is a timer interrupt.&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;if(which_dev == 2)&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;yield();&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;usertrapret();&lt;/font&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;align=center;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-64">
          <mxGeometry width="338" height="270" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-62" value="usertrap()" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-64">
          <mxGeometry x="115" y="270" width="108" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-65" value="&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;&lt;b&gt;# userret(TRAPFRAME, pagetable)&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; font-size: 14px;&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;1. Switch to the user page table&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 14px;&quot;&gt;&lt;div style=&quot;text-align: justify; border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 14px;&quot;&gt;================= Fence (for page table) ==================&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 14px;&quot;&gt;2. P&lt;/font&gt;ut the saved user a0 in sscratch, so we&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;can swap it with our a0 (TRAPFRAME) in the last step.&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;3. Restore&lt;/span&gt;&amp;nbsp;all but a0 from TRAPFRAME&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 14px;&quot;&gt;4. swap a0 and sscratch. (restore user a0)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify; border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;border-color: var(--border-color); font-size: 14px;&quot;&gt;5.&amp;nbsp;&lt;font style=&quot;font-size: 14px;&quot; color=&quot;#0000ff&quot;&gt;sret&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=center;" vertex="1" parent="1">
          <mxGeometry x="832" y="760" width="628" height="180" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-66" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0;entryDx=0;entryDy=0;endArrow=none;endFill=0;" edge="1" parent="1" source="rG94a1LRT6dkGuhy65Fh-32" target="rG94a1LRT6dkGuhy65Fh-65">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-67" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;endArrow=none;endFill=0;" edge="1" parent="1" source="rG94a1LRT6dkGuhy65Fh-32" target="rG94a1LRT6dkGuhy65Fh-65">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-72" value="" style="group" vertex="1" connectable="0" parent="1">
          <mxGeometry x="1550" y="830" width="540" height="390" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-70" value="&lt;div style=&quot;text-align: justify;&quot;&gt;intr_off(); // Disable interrupt&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;Make stvec point to&amp;nbsp;&lt;/span&gt;&lt;b&gt;uservec&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;text-align: justify;&quot;&gt;&lt;div&gt;&lt;b&gt;Set up trapframe values that uservec will need when&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;the process next re-enters the kernel.&lt;/span&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;p-&amp;gt;trapframe-&amp;gt;kernel_satp = r_satp();&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;// kernel page table&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;b&gt;Set S Previous Privilege mode to User.&lt;/b&gt;&lt;/div&gt;&lt;div&gt;unsigned long x = r_sstatus();&lt;/div&gt;&lt;div&gt;x &amp;amp;= ~SSTATUS_SPP; // clear SPP to 0 for user mode&lt;/div&gt;&lt;div&gt;x |= SSTATUS_SPIE; // enable interrupts in user mode&lt;/div&gt;&lt;div&gt;w_sstatus(x);&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;b&gt;Set S Exception Program Counter to the saved user pc.&lt;/b&gt;&lt;/div&gt;&lt;div&gt;w_sepc(p-&amp;gt;trapframe-&amp;gt;epc);&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;b&gt;Tell trampoline.S the user page table to switch to.&lt;/b&gt;&lt;/div&gt;&lt;div&gt;uint64 satp = MAKE_SATP(p-&amp;gt;pagetable);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Jump to trampoline.S at the top of memory, which&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;switches to the user page table,&amp;nbsp;&lt;/span&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;restores user registers,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;and switches to user mode with sret.&lt;/span&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;uint64 fn = TRAMPOLINE + (userret - trampoline);&lt;/div&gt;&lt;div&gt;((void (*)(uint64,uint64))fn)(TRAPFRAME, satp);&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;align=center;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-72">
          <mxGeometry width="540" height="360" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-71" value="usertrapret()" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="rG94a1LRT6dkGuhy65Fh-72">
          <mxGeometry x="166" y="360" width="108" height="30" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-73" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;entryX=0;entryY=0.074;entryDx=0;entryDy=0;entryPerimeter=0;fillColor=default;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1630" y="710" as="sourcePoint" />
            <mxPoint x="1630" y="845.02" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-74" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;fillColor=default;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1540" y="840" as="sourcePoint" />
            <mxPoint x="1450" y="840" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-75" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.01;entryY=0.625;entryDx=0;entryDy=0;entryPerimeter=0;curved=1;fillColor=#d5e8d4;strokeColor=#00CC00;" edge="1" parent="1" source="rG94a1LRT6dkGuhy65Fh-32" target="rG94a1LRT6dkGuhy65Fh-15">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="340" y="645" />
              <mxPoint x="340" y="112" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-82" value="&lt;font style=&quot;font-size: 25px;&quot;&gt;User&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="870" y="40" width="90" height="60" as="geometry" />
        </mxCell>
        <mxCell id="rG94a1LRT6dkGuhy65Fh-83" value="&lt;font style=&quot;font-size: 25px;&quot;&gt;Kernel&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="870" y="300" width="90" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
